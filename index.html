<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tester — Campaign Significance</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  <style>
    :root {
      color-scheme: light;
      --ink: #0d1b2a;
      --muted: #5b6777;
      --accent: #ef476f;
      --accent-2: #118ab2;
      --bg: #f7f3e9;
      --panel: #ffffff;
      --shadow: 0 20px 60px rgba(13, 27, 42, 0.12);
      --radius: 18px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Avenir Next", "Futura", "Trebuchet MS", "Segoe UI", sans-serif;
      background: radial-gradient(1200px 600px at 10% -10%, #ffd9a1 0%, transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, #bde0fe 0%, transparent 60%),
                  var(--bg);
      color: var(--ink);
      min-height: 100vh;
      padding: 32px 18px 60px;
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      gap: 24px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      background: conic-gradient(from 180deg, #ffd166, #ef476f, #118ab2, #06d6a0, #ffd166);
      box-shadow: inset 0 0 0 3px rgba(255,255,255,0.7);
    }

    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: -0.02em;
    }

    h2 {
      margin: 0 0 8px 0;
      font-size: 20px;
      font-weight: 700;
    }

    .tagline {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(260px, 1fr) minmax(340px, 1.35fr);
      gap: 24px;
    }

    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }

    .panel {
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px;
    }

    .inputs {
      display: grid;
      gap: 14px;
    }


    .group-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
    }

    .group-box {
      border: 1px solid #e7ecf3;
      background: linear-gradient(180deg, #ffffff 0%, #f7f9fc 100%);
      border-radius: 16px;
      padding: 16px;
    }

    .group-box h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      letter-spacing: 0.01em;
      text-transform: uppercase;
      color: #334155;
    }

    .input-row {
      display: grid;
      gap: 8px;
    }

    .input-row + .input-row {
      margin-top: 6px;
    }

    .bayes-only {
      display: block;
    }

    .bayes-only.active {
      display: block;
    }

    .freq-only.hidden {
      display: block;
    }


    label {
      font-weight: 600;
      font-size: 14px;
    }

    label .tip-target {
      display: inline-grid;
      place-items: center;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      margin-left: 6px;
      font-size: 12px;
      font-weight: 800;
      color: #334155;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      vertical-align: middle;
      line-height: 1;
    }

    input[type="number"] {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #dfe3ea;
      font-size: 15px;
      outline: none;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    select {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #dfe3ea;
      font-size: 15px;
      outline: none;
      background: #fff;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="number"]:focus,
    select:focus {
      border-color: var(--accent-2);
      box-shadow: 0 0 0 3px rgba(17, 138, 178, 0.15);
    }

    .btn {
      border: none;
      background: linear-gradient(130deg, var(--accent), #ff9f1c);
      color: white;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      letter-spacing: 0.01em;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(239, 71, 111, 0.2); }

    .note {
      font-size: 13px;
      color: var(--muted);
    }

    .results-shell {
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 18px;
      padding: 14px;
      border: 1px solid #e7ecf3;
    }

    .results-cards {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }

    @media (max-width: 520px) {
      .results-cards { grid-template-columns: 1fr; }
    }

    .results-under {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
      margin-top: 14px;
    }

    @media (max-width: 520px) {
      .results-under { grid-template-columns: 1fr; }
    }

    .result-card {
      border-radius: 16px;
      background: #f8fafc;
      border: 1px solid #eef2f7;
      padding: 16px;
      display: grid;
      grid-template-columns: 34px 1fr;
      gap: 12px;
      align-items: center;
      box-shadow: 0 10px 22px rgba(13, 27, 42, 0.06);
    }

    .result-icon {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      background: #eef2ff;
      border: 1px solid rgba(15, 23, 42, 0.06);
    }

    .result-label {
      font-size: 13px;
      color: #475569;
      letter-spacing: 0.01em;
    }

    .result-value {
      font-size: 30px;
      letter-spacing: -0.03em;
      font-weight: 700;
      color: #0d1b2a;
      margin-top: 6px;
      line-height: 1.0;
    }

    .result-unit {
      margin-top: 4px;
      font-size: 12px;
      color: #64748b;
    }

    .verdict-good .result-icon { background: #eafff6 !important; }
    .verdict-good .result-value { color: #14532d; }
    .verdict-bad .result-icon { background: #fff7ed !important; }
    .verdict-bad .result-value { color: #7c2d12; }

    .chart-wrap {
      display: grid;
      gap: 14px;
    }

    .chart {
      width: 100%;
      height: 280px;
      border-radius: 16px;
      background: linear-gradient(180deg, #ffffff 0%, #f1f5fb 100%);
      border: 1px solid #e7ecf3;
      padding: 8px;
    }

    .chart.small {
      height: 220px;
    }

    @media (max-width: 520px) {
      .chart.small { height: 260px; }
      .chart { height: 360px; }
      .chart-title h3 { font-size: 16px; }
    }

    .chart-title {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
    }

    .chart-title h3 {
      margin: 0;
      font-size: 14px;
      letter-spacing: 0.01em;
      text-transform: uppercase;
      color: #475569;
      font-weight: 600;
    }

    .chart-title .subnote {
      font-size: 12px;
      color: var(--muted);
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 12px;
      color: var(--muted);
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }

    .tip-target { cursor: help; }

    .tooltip {
      position: fixed;
      z-index: 9999;
      max-width: 320px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(13, 27, 42, 0.92);
      color: rgba(255,255,255,0.92);
      font-size: 12px;
      line-height: 1.35;
      box-shadow: 0 18px 40px rgba(13, 27, 42, 0.25);
      pointer-events: none;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.12s ease, transform 0.12s ease;
    }

    .tooltip.on {
      opacity: 1;
      transform: translateY(0);
    }

    .commentary {
      background: #fff7ed;
      border-radius: 14px;
      padding: 14px 16px;
      border: 1px solid #ffe4c4;
      font-size: 14px;
      line-height: 1.5;
    }

    .commentary ul {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 6px;
    }

    .commentary li {
      margin: 0;
    }

    .footer {
      font-size: 12px;
      color: var(--muted);
    }

    a.ext-link {
      color: inherit;
      text-decoration: underline;
      text-decoration-thickness: 1px;
      text-underline-offset: 2px;
    }

    a.ext-link:hover {
      text-decoration-thickness: 2px;
    }

    .pulse {
      animation: fadeUp 0.6s ease;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Tester</h1>
          <p class="tagline">A tool for interpreting ad campaign lift studies.</p>
        </div>
      </div>
    </header>

    <div class="grid">
      <section class="panel">
        <h2>Campaign Inputs</h2>
        <p class="note">Start by entering data from your <a class="ext-link" href="https://en.wikipedia.org/wiki/Randomized_controlled_trial" target="_blank" rel="noopener noreferrer">Randomized Controlled Trial</a> study. Enter the sample sizes and number of successes for both groups.</p>
        <div class="inputs">
          <div class="group-grid">
            <div class="group-box">
              <h3>Control Group</h3>
              <div class="input-row">
                <label for="controlSize">Sample Size (n₁)</label>
                <input id="controlSize" type="number" min="1" value="500" />
              </div>
              <div class="input-row">
                <label for="controlConv">Number of Successes (x₁) <span class="tip-target" data-tip="Typically the number of conversions or desired survey responses recorded.">?</span></label>
                <input id="controlConv" type="number" min="0" value="120" />
              </div>
            </div>
            <div class="group-box">
              <h3>Test Group</h3>
              <div class="input-row">
                <label for="testSize">Sample Size (n₂)</label>
                <input id="testSize" type="number" min="1" value="500" />
              </div>
              <div class="input-row">
                <label for="testConv">Number of Successes (x₂) <span class="tip-target" data-tip="Typically the number of conversions or desired survey responses recorded.">?</span></label>
                <input id="testConv" type="number" min="0" value="150" />
              </div>
            </div>
          </div>
          <button class="btn" id="calcBtn">Calculate significance</button>
          <div class="note" id="validation"></div>
        </div>
      </section>

      <section class="panel">
        <div class="chart-wrap">
          <h2>Results</h2>
          <div class="chart-title">
            <h3>Lift</h3>
          </div>
          <div class="chart small">
            <svg id="bars" viewBox="0 0 600 220" width="100%" height="100%" role="img" aria-label="Control vs test conversion rates">
              <rect x="0" y="0" width="600" height="220" fill="transparent"></rect>
              <g id="barsGrid"></g>
              <g id="barsLayer"></g>
              <g id="barsAnnot"></g>
            </svg>
          </div>
          <div class="chart-title">
            <h3>Analysis</h3>
          </div>
          <div class="results-shell">
            <div class="results-cards" id="metrics">
              <div class="result-card tip-target" id="tileLift" data-tip="">
                <div class="result-icon" style="background:#eafff6">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M5 12h12" stroke="#16a34a" stroke-width="2.6" stroke-linecap="round"/>
                    <path d="M13 6l6 6-6 6" stroke="#16a34a" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div>
                  <div class="result-label">Observed Lift (Signal)</div>
                  <div class="result-value" id="lift">—</div>
                  <div class="result-unit">percentage points</div>
                </div>
              </div>
              <div class="result-card tip-target" id="tileSe" data-tip="">
                <div class="result-icon" style="background:#eef2ff">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M12 3v10" stroke="#334155" stroke-width="2.4" stroke-linecap="round"/>
                    <path d="M8 13c.9 1.2 2.2 2 4 2s3.1-.8 4-2" stroke="#334155" stroke-width="2.4" stroke-linecap="round"/>
                    <path d="M6 21h12" stroke="#334155" stroke-width="2.4" stroke-linecap="round"/>
                  </svg>
                </div>
                <div>
                  <div class="result-label">Standard Error (Noise)</div>
                  <div class="result-value" id="se">—</div>
                  <div class="result-unit">percentage points</div>
                </div>
              </div>
              <div class="result-card tip-target" id="tileZ" data-tip="">
                <div class="result-icon" style="background:#f1f5f9">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M10 18a8 8 0 1 1 5.3-14" stroke="#334155" stroke-width="2.4" stroke-linecap="round"/>
                    <path d="M16 16l5 5" stroke="#334155" stroke-width="2.4" stroke-linecap="round"/>
                  </svg>
                </div>
                <div>
                  <div class="result-label">Signal-to-Noise (Z-Score)</div>
                  <div class="result-value" id="zscore">—</div>
                  <div class="result-unit">standard deviations</div>
                </div>
              </div>
              <div class="result-card tip-target" id="tileP" data-tip="">
                <div class="result-icon" style="background:#fff7ed">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M12 17v.01" stroke="#ea580c" stroke-width="3" stroke-linecap="round"/>
                    <path d="M9.1 9.4a3.2 3.2 0 1 1 5.2 2.5c-.9.6-1.3 1.1-1.3 2.1v.4" stroke="#ea580c" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 22a10 10 0 1 0-10-10 10 10 0 0 0 10 10Z" stroke="#ea580c" stroke-width="2.0" opacity="0.25"/>
                  </svg>
                </div>
                <div>
                  <div class="result-label">Risk of Chance (P-Value)</div>
                  <div class="result-value" id="pscore">—</div>
                  <div class="result-unit">two-tailed probability</div>
                </div>
              </div>
            </div>
          <div class="results-under">
            <div class="result-card tip-target" id="tileConfidence" data-tip="">
              <div class="result-icon" style="background:#f1f5ff">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M12 3v18" stroke="#334155" stroke-width="2.4" stroke-linecap="round"/>
                    <path d="M7 8h10" stroke="#334155" stroke-width="2.4" stroke-linecap="round"/>
                    <path d="M7 16h10" stroke="#334155" stroke-width="2.4" stroke-linecap="round"/>
                  </svg>
                </div>
                <div>
                  <div class="result-label" id="confidenceLabel">Confidence</div>
                  <div class="result-value" id="confidence">—</div>
                  <div class="result-unit" id="confidenceUnit">confidence level (1 - p-value)</div>
                </div>
              </div>
              <div class="result-card tip-target" id="verdictCard" data-tip="">
                <div class="result-icon" style="background:#f1f5f9">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M9 12l2 2 4-5" stroke="#16a34a" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 22a10 10 0 1 0-10-10 10 10 0 0 0 10 10Z" stroke="#16a34a" stroke-width="2.0" opacity="0.22"/>
                  </svg>
                </div>
                <div>
                  <div class="result-label">Verdict</div>
                  <div class="result-value" id="verdict">—</div>
                  <div class="result-unit" id="verdictUnit">—</div>
                </div>
              </div>
            </div>
          </div>
          <div class="chart-title freq-only" id="freqTitle">
            <h3>Effect vs Chance (Z-Score)</h3>
          </div>
          <div class="chart freq-only" id="freqChartWrap">
            <svg id="curve" viewBox="0 0 600 300" width="100%" height="100%" role="img" aria-label="Effect vs chance (Z-score)">
              <defs>
                <linearGradient id="shade" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0%" stop-color="#ef476f" stop-opacity="0.45" />
                  <stop offset="100%" stop-color="#ef476f" stop-opacity="0.05" />
                </linearGradient>
                <linearGradient id="noEffectGrad" x1="0" x2="1" y1="0" y2="0">
                  <stop offset="0%" stop-color="#f3e3ee" />
                  <stop offset="50%" stop-color="#e5e7eb" />
                  <stop offset="100%" stop-color="#e1f3ea" />
                </linearGradient>
              </defs>
              <g id="noiseBands"></g>
              <path id="shadeLeft" fill="#f472b6" opacity="0.30" />
              <path id="shadeRight" fill="#16a34a" opacity="0.24" />
              <path id="sig95Area" fill="url(#noEffectGrad)" opacity="0.85" />
              <line id="critLeft" x1="0" x2="0" y1="70" y2="210" stroke="#94a3b8" stroke-width="2" stroke-dasharray="6 6" opacity="0.55" />
              <line id="critRight" x1="0" x2="0" y1="70" y2="210" stroke="#94a3b8" stroke-width="2" stroke-dasharray="6 6" opacity="0.55" />
              <path id="curvePath" fill="none" stroke="#0d1b2a" stroke-width="3" />
              <line id="zLine" x1="300" x2="300" y1="138" y2="220" stroke="#118ab2" stroke-width="3" stroke-linecap="round" />
              <circle id="zDot" cx="300" cy="110" r="30" fill="#ffffff" stroke="#118ab2" stroke-width="3" />
              <text id="zDotLabel" x="300" y="108" text-anchor="middle" font-size="11" fill="#118ab2" font-weight="800">Z =</text>
              <text id="zDotText" x="300" y="126" text-anchor="middle" font-size="14" fill="#118ab2" font-weight="900">0.00</text>
              <g id="confBadge">
                <rect id="confBadgeRect" x="410" y="4" width="170" height="32" rx="14" fill="rgba(255,255,255,0.92)" stroke="#ef476f" stroke-width="2" />
                <text id="confBadgeText" x="495" y="25" text-anchor="middle" font-size="12" fill="#ef476f" font-weight="800">—</text>
              </g>
              <g id="ticks" fill="none" stroke="#dbe2ea" stroke-width="2" opacity="0.95">
                <line x1="40" x2="560" y1="210" y2="210" />
                <line x1="40" x2="40" y1="210" y2="218" />
                <line x1="105" x2="105" y1="210" y2="216" />
                <line x1="170" x2="170" y1="210" y2="216" />
                <line x1="235" x2="235" y1="210" y2="216" />
                <line x1="300" x2="300" y1="210" y2="218" />
                <line x1="365" x2="365" y1="210" y2="216" />
                <line x1="430" x2="430" y1="210" y2="216" />
                <line x1="495" x2="495" y1="210" y2="216" />
                <line x1="560" x2="560" y1="210" y2="218" />
              </g>
              <g id="tickLabels" font-size="12" fill="#5b6777">
                <text x="40" y="232">-4</text>
                <text x="105" y="232" text-anchor="middle">-3</text>
                <text x="170" y="232" text-anchor="middle">-2</text>
                <text x="235" y="232" text-anchor="middle">-1</text>
                <text x="300" y="232" text-anchor="middle">0</text>
                <text x="365" y="232" text-anchor="middle">1</text>
                <text x="430" y="232" text-anchor="middle">2</text>
                <text x="495" y="232" text-anchor="middle">3</text>
                <text x="560" y="232" text-anchor="end">4</text>
                <text x="570" y="232" text-anchor="start" font-size="12" fill="#94a3b8">σ</text>
              </g>
              <g id="noEffectLabel">
                <text x="300" y="256" text-anchor="middle" font-size="12" fill="#5b6777" font-weight="800">No Clear Effect</text>
                <text id="negLabel" x="160" y="256" text-anchor="middle" font-size="12" fill="#5b6777" font-weight="800">Negative Effect</text>
                <text id="posLabel" x="440" y="256" text-anchor="middle" font-size="12" fill="#5b6777" font-weight="800">Positive Effect</text>
              </g>
              <g id="hitLayer">
                <path id="hitSig95" class="tip-target" fill="transparent" data-tip="Z values closer to 0 look like random noise (no clear measured effect). Outside the pink zone (|Z| > 1.96) is statistically significant at 95%. Results between 80–95% significance can be indicative (often used for tactical decisions) but still inconclusive."></path>
                <path id="hitPLeft" class="tip-target" fill="transparent" data-tip="Statistically significant zone: outcomes in the tails (outside ±1.96) are rare by chance alone at the 95% level (two-tailed). Farther from 0 (larger |Z|) means a smaller p-value (lower chance the result is just noise)."></path>
                <path id="hitPRight" class="tip-target" fill="transparent" data-tip="Statistically significant zone: outcomes in the tails (outside ±1.96) are rare by chance alone at the 95% level (two-tailed). Farther from 0 (larger |Z|) means a smaller p-value (lower chance the result is just noise)."></path>
                <line id="hitZLine" class="tip-target" x1="300" x2="300" y1="30" y2="210" stroke="transparent" stroke-width="18" data-tip="Observed Z-score: how many 'noise units' away from no clear effect. |Z| > 1.96 is significant at 95%; 80–95% can be indicative but still inconclusive."></line>
                <line id="hitCritLeft" class="tip-target" x1="0" x2="0" y1="70" y2="210" stroke="transparent" stroke-width="14" data-tip="95% cutoff (z = -1.96). Crossing this line means the result is significant at 95% (two-tailed)."></line>
                <line id="hitCritRight" class="tip-target" x1="0" x2="0" y1="70" y2="210" stroke="transparent" stroke-width="14" data-tip="95% cutoff (z = +1.96). Crossing this line means the result is significant at 95% (two-tailed)."></line>
              </g>
            </svg>
          </div>
          <div class="chart-title bayes-only" id="bayesTitle">
            <h3>Bayesian Probability Distribution</h3>
          </div>
          <div class="chart bayes-only" id="bayesChartWrap">
            <svg id="bayesChart" viewBox="0 0 600 260" width="100%" height="100%" role="img" aria-label="Bayesian posterior distributions">
              <rect x="0" y="0" width="600" height="260" fill="transparent"></rect>
              <g id="bayesGrid"></g>
              <path id="bayesControlFill" fill="rgba(79,156,255,0.18)" />
              <path id="bayesTestFill" fill="rgba(124,58,237,0.18)" />
              <path id="bayesControl" fill="none" stroke="#4f9cff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
              <path id="bayesTest" fill="none" stroke="#7c3aed" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
              <g id="bayesLegend"></g>
              <g id="bayesCallout"></g>
            </svg>
          </div>
          <div class="chart-title">
            <h3>Summary</h3>
          </div>
          <div class="commentary" id="commentary">Enter your data and calculate to see interpretation.</div>
        </div>
      </section>
    </div>

    <div class="footer">Created by <a class="ext-link" href="https://www.linkedin.com/in/ivomajors/" target="_blank" rel="noopener noreferrer">Ivo Majors</a>. Not for commercial use.</div>
  </div>

  <div id="tooltip" class="tooltip" role="status" aria-live="polite"></div>

  <script>
    const controlSize = document.getElementById('controlSize');
    const controlConv = document.getElementById('controlConv');
    const testSize = document.getElementById('testSize');
    const testConv = document.getElementById('testConv');
    const validation = document.getElementById('validation');
    const bayesFields = Array.from(document.querySelectorAll('.bayes-only'));
    const calcBtn = document.getElementById('calcBtn');

    const liftEl = document.getElementById('lift');
    const seEl = document.getElementById('se');
    const zEl = document.getElementById('zscore');
    const pEl = document.getElementById('pscore');
    const confidenceEl = document.getElementById('confidence');
    const verdictEl = document.getElementById('verdict');
    const verdictCard = document.getElementById('verdictCard');
    const verdictUnit = document.getElementById('verdictUnit');
    const confidenceLabel = document.getElementById('confidenceLabel');
    const confidenceUnit = document.getElementById('confidenceUnit');
    const commentary = document.getElementById('commentary');
    const tileLift = document.getElementById('tileLift');
    const tileSe = document.getElementById('tileSe');
    const tileZ = document.getElementById('tileZ');
    const tileP = document.getElementById('tileP');
    const tileConfidence = document.getElementById('tileConfidence');
    const barsGrid = document.getElementById('barsGrid');
    const barsLayer = document.getElementById('barsLayer');
    const barsAnnot = document.getElementById('barsAnnot');

    const curvePath = document.getElementById('curvePath');
    const noiseBands = document.getElementById('noiseBands');
    const shadeLeft = document.getElementById('shadeLeft');
    const shadeRight = document.getElementById('shadeRight');
    const sig95Area = document.getElementById('sig95Area');
    const critLeft = document.getElementById('critLeft');
    const critRight = document.getElementById('critRight');
    const zLine = document.getElementById('zLine');
    const zDot = document.getElementById('zDot');
    const zDotText = document.getElementById('zDotText');
    const zDotLabel = document.getElementById('zDotLabel');
    const confBadgeText = document.getElementById('confBadgeText');
    const confBadgeRect = document.getElementById('confBadgeRect');
    const bayesTitle = document.getElementById('bayesTitle');
    const bayesChartWrap = document.getElementById('bayesChartWrap');
    const bayesGrid = document.getElementById('bayesGrid');
    const bayesControl = document.getElementById('bayesControl');
    const bayesTest = document.getElementById('bayesTest');
    const bayesControlFill = document.getElementById('bayesControlFill');
    const bayesTestFill = document.getElementById('bayesTestFill');
    const bayesLegend = document.getElementById('bayesLegend');
    const bayesCallout = document.getElementById('bayesCallout');
    const freqTitle = document.getElementById('freqTitle');
    const freqChartWrap = document.getElementById('freqChartWrap');
    const hitSig95 = document.getElementById('hitSig95');
    const hitPLeft = document.getElementById('hitPLeft');
    const hitPRight = document.getElementById('hitPRight');
    const hitZLine = document.getElementById('hitZLine');
    const hitCritLeft = document.getElementById('hitCritLeft');
    const hitCritRight = document.getElementById('hitCritRight');
    const negLabel = document.getElementById('negLabel');
    const posLabel = document.getElementById('posLabel');
    const tooltip = document.getElementById('tooltip');

    const Z_CRIT_95 = 1.959963984540054;

    function normalPdf(x) {
      return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
    }

    function normalCdf(x) {
      const sign = x < 0 ? -1 : 1;
      const absX = Math.abs(x) / Math.sqrt(2);
      const t = 1 / (1 + 0.3275911 * absX);
      const a1 = 0.254829592;
      const a2 = -0.284496736;
      const a3 = 1.421413741;
      const a4 = -1.453152027;
      const a5 = 1.061405429;
      const erf = 1 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-absX * absX);
      return 0.5 * (1 + sign * erf);
    }

    function formatPercent(val) {
      if (!isFinite(val)) return '—';
      return `${(val * 100).toFixed(2)}%`;
    }

    function formatNumber(val) {
      if (!isFinite(val)) return '—';
      return val.toFixed(4);
    }

    function formatRate(val) {
      if (!isFinite(val)) return '—';
      return val.toFixed(4);
    }

    function formatPPValue(val) {
      if (!isFinite(val)) return '—';
      return (val * 100).toFixed(2);
    }

    function formatPP(val) {
      if (!isFinite(val)) return '—';
      return `${(val * 100).toFixed(2)} pp`;
    }

    function formatPercentValue(val) {
      if (!isFinite(val)) return '—';
      return `${(val * 100).toFixed(2)}%`;
    }

    function setModeUI() {
      bayesFields.forEach(el => el.classList.add('active'));
      if (calcBtn) {
        calcBtn.textContent = 'Calculate results';
      }
    }

    function clamp(val, min, max) {
      return Math.min(max, Math.max(min, val));
    }

    function logGamma(z) {
      const g = 7;
      const p = [
        0.99999999999980993,
        676.5203681218851,
        -1259.1392167224028,
        771.3234287776531,
        -176.6150291621406,
        12.507343278686905,
        -0.13857109526572012,
        9.984369578019571e-6,
        1.5056327351493116e-7,
      ];
      if (z < 0.5) {
        return Math.log(Math.PI) - Math.log(Math.sin(Math.PI * z)) - logGamma(1 - z);
      }
      z -= 1;
      let x = p[0];
      for (let i = 1; i < p.length; i++) {
        x += p[i] / (z + i);
      }
      const t = z + g + 0.5;
      return 0.5 * Math.log(2 * Math.PI) + (z + 0.5) * Math.log(t) - t + Math.log(x);
    }

    function betaPdf(x, a, b) {
      if (x <= 0 || x >= 1) return 0;
      return Math.exp((a - 1) * Math.log(x) + (b - 1) * Math.log(1 - x) - (logGamma(a) + logGamma(b) - logGamma(a + b)));
    }

    let _spareNormal = null;
    function randn() {
      if (_spareNormal !== null) {
        const n = _spareNormal;
        _spareNormal = null;
        return n;
      }
      let u = 0;
      let v = 0;
      while (u === 0) u = Math.random();
      while (v === 0) v = Math.random();
      const mag = Math.sqrt(-2 * Math.log(u));
      const z0 = mag * Math.cos(2 * Math.PI * v);
      const z1 = mag * Math.sin(2 * Math.PI * v);
      _spareNormal = z1;
      return z0;
    }

    function gammaSample(k, theta) {
      if (k < 1) {
        const u = Math.random();
        return gammaSample(1 + k, theta) * Math.pow(u, 1 / k);
      }
      const d = k - 1 / 3;
      const c = 1 / Math.sqrt(9 * d);
      while (true) {
        const x = randn();
        let v = 1 + c * x;
        if (v <= 0) continue;
        v = v * v * v;
        const u = Math.random();
        if (u < 1 - 0.0331 * x * x * x * x) return d * v * theta;
        if (Math.log(u) < 0.5 * x * x + d * (1 - v + Math.log(v))) return d * v * theta;
      }
    }

    function betaSample(a, b) {
      const x = gammaSample(a, 1);
      const y = gammaSample(b, 1);
      return x / (x + y);
    }

    function drawBayesPosterior(a1, b1, a2, b2, p1, p2) {
      const W = 600;
      const H = 260;
      const padL = 56;
      const padR = 26;
      const padT = 22;
      const padB = 42;
      const baseY = H - padB;
      const steps = 220;
      const mid = (p1 + p2) / 2;
      const span = 0.18 + Math.min(0.14, Math.abs(p2 - p1) * 2);
      const xMin = clamp(mid - span, 0, 1);
      const xMax = clamp(mid + span, 0, 1);
      const xRange = Math.max(1e-6, xMax - xMin);
      const xs = [];
      let maxY = 0;
      for (let i = 1; i < steps; i++) {
        const x = xMin + (xRange * i) / steps;
        const y1 = betaPdf(x, a1, b1);
        const y2 = betaPdf(x, a2, b2);
        maxY = Math.max(maxY, y1, y2);
        xs.push({ x, y1, y2 });
      }
      const scaleX = (W - padL - padR);
      const scaleY = (baseY - padT) / (maxY || 1);
      let d1 = '';
      let d2 = '';
      xs.forEach((pt, i) => {
        const nx = (pt.x - xMin) / xRange;
        const px = padL + nx * scaleX;
        const py1 = baseY - pt.y1 * scaleY;
        const py2 = baseY - pt.y2 * scaleY;
        d1 += `${i === 0 ? 'M' : 'L'} ${px} ${py1} `;
        d2 += `${i === 0 ? 'M' : 'L'} ${px} ${py2} `;
      });
      bayesControl.setAttribute('d', d1.trim());
      bayesTest.setAttribute('d', d2.trim());
      const firstX = padL;
      const lastX = W - padR;
      const fill1 = `${d1} L ${lastX} ${baseY} L ${firstX} ${baseY} Z`;
      const fill2 = `${d2} L ${lastX} ${baseY} L ${firstX} ${baseY} Z`;
      bayesControlFill.setAttribute('d', fill1.trim());
      bayesTestFill.setAttribute('d', fill2.trim());

      const grid = [];
      const axisStroke = '#dbe2ea';
      const gridStroke = '#e8eef7';
      const axisText = '#5b6777';

      // axes
      grid.push(`<line x1="${padL}" x2="${W - padR}" y1="${baseY}" y2="${baseY}" stroke="${axisStroke}" stroke-width="2"></line>`);
      grid.push(`<line x1="${padL}" x2="${padL}" y1="${padT}" y2="${baseY}" stroke="${axisStroke}" stroke-width="2"></line>`);

      // horizontal gridlines
      for (const frac of [1 / 3, 2 / 3]) {
        const yy = padT + (baseY - padT) * frac;
        grid.push(`<line x1="${padL}" x2="${W - padR}" y1="${yy}" y2="${yy}" stroke="${gridStroke}" stroke-width="2"></line>`);
      }

      // x ticks
      const tickStep = xRange <= 0.32 ? 0.05 : 0.1;
      const start = Math.ceil(xMin / tickStep) * tickStep;
      const end = Math.floor(xMax / tickStep) * tickStep;
      for (let t = start; t <= end + 1e-12; t += tickStep) {
        const nx = (t - xMin) / xRange;
        const px = padL + nx * scaleX;
        grid.push(`<line x1="${px}" x2="${px}" y1="${baseY}" y2="${baseY + 7}" stroke="${axisStroke}" stroke-width="2"></line>`);
        grid.push(`<text x="${px}" y="${baseY + 22}" font-size="12" fill="${axisText}" text-anchor="middle">${(t * 100).toFixed(0)}%</text>`);
        grid.push(`<line x1="${px}" x2="${px}" y1="${padT}" y2="${baseY}" stroke="${gridStroke}" stroke-width="2" opacity="0.65"></line>`);
      }

      // axis labels
      const yLabelX = padL - 34;
      const yLabelY = (padT + baseY) / 2;
      grid.push(`<text x="${yLabelX}" y="${yLabelY}" font-size="12" fill="${axisText}" text-anchor="middle" transform="rotate(-90 ${yLabelX} ${yLabelY})">Probability Density</text>`);
      grid.push(`<text x="${(W - padR + padL) / 2}" y="${H - 6}" font-size="12" fill="${axisText}" text-anchor="middle">Conversion Rate</text>`);

      bayesGrid.innerHTML = grid.join('');

      const controlLabel = `Control`;
      const testLabel = `Test`;
      const legendW = 160;
      const legendH = 56;
      const legendX = W - padR - legendW;
      const legendY = padT + 34;
      bayesLegend.innerHTML = `
        <rect x="${legendX}" y="${legendY}" width="${legendW}" height="${legendH}" rx="12" fill="rgba(255,255,255,0.94)" stroke="#dbe2ea"/>
        <line x1="${legendX + 14}" y1="${legendY + 20}" x2="${legendX + 44}" y2="${legendY + 20}" stroke="#4f9cff" stroke-width="4" stroke-linecap="round"/>
        <text x="${legendX + 54}" y="${legendY + 24}" font-size="13" font-weight="700" fill="#334155">${escapeText(controlLabel)}</text>
        <line x1="${legendX + 14}" y1="${legendY + 40}" x2="${legendX + 44}" y2="${legendY + 40}" stroke="#7c3aed" stroke-width="4" stroke-linecap="round"/>
        <text x="${legendX + 54}" y="${legendY + 44}" font-size="13" font-weight="700" fill="#334155">${escapeText(testLabel)}</text>
      `;
    }

    function escapeText(text) {
      return String(text).replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));
    }

    function drawBars({ n1, c1, p1, n2, c2, p2, delta, lift, se, confValue, confLabel }) {
      const W = 600;
      const H = 220;
      const padL = 58;
      const padR = 20;
      const padT = 18;
      const padB = 46;
      const baseY = H - padB;

      const maxRate = Math.max(p1, p2, 0.0001);
      const yMax = Math.max(0.02, maxRate * 1.25);
      const yScale = (baseY - padT) / yMax;
      const y = (rate) => baseY - rate * yScale;

      const xControl = padL + 95;
      const xLift = (W - padR + padL) / 2;
      const xTest = W - padR - 95;
      const barW = 104;
      const liftW = 112;

      const controlColor = '#4f9cff';
      const liftColor = '#2dd4bf';
      const testColor = '#7c3aed';

      const grid = [];
      for (const frac of [0.25, 0.5, 0.75]) {
        const yy = padT + (baseY - padT) * frac;
        grid.push(`<line x1="${padL}" x2="${W - padR}" y1="${yy}" y2="${yy}" stroke="#e8eef7" stroke-width="2"></line>`);
      }
      barsGrid.innerHTML = grid.join('');

      const controlTopY = y(p1);
      const testTopY = y(p2);
      const controlH = Math.max(0, baseY - controlTopY);
      const testH = Math.max(0, baseY - testTopY);

      const liftFrom = p1;
      const liftTo = p2;
      const liftTopY = y(Math.max(liftFrom, liftTo));
      const liftBotY = y(Math.min(liftFrom, liftTo));
      const liftH = Math.max(2, liftBotY - liftTopY);
      const liftY = delta >= 0 ? y(p2) : y(p1);

      const controlX0 = xControl - barW / 2;
      const controlX1 = xControl + barW / 2;
      const liftX0 = xLift - liftW / 2;
      const liftX1 = xLift + liftW / 2;
      const testX0 = xTest - barW / 2;
      const testX1 = xTest + barW / 2;

      barsLayer.innerHTML = [
        `<rect x="${controlX0}" y="${controlTopY}" width="${barW}" height="${controlH}" rx="14" fill="${controlColor}" opacity="0.95"></rect>`,
        `<rect x="${liftX0}" y="${liftTopY}" width="${liftW}" height="${liftH}" rx="14" fill="${liftColor}" opacity="0.95"></rect>`,
        `<rect x="${testX0}" y="${testTopY}" width="${barW}" height="${testH}" rx="14" fill="${testColor}" opacity="0.95"></rect>`,
      ].join('');

      const connector = (x1, y1, x2, y2) => `<path d="M ${x1} ${y1} L ${x2} ${y2}" stroke="${liftColor}" stroke-width="5" stroke-linecap="round" stroke-dasharray="8 8" opacity="0.55"></path>`;

      const liftLabel = `${delta >= 0 ? '+' : ''}${formatPP(delta)}`;
      const confText = `${formatPercent(confValue)} ${confLabel}`;

      barsAnnot.innerHTML = [
        connector(controlX1 + 10, controlTopY, liftX0 - 10, y(p1)),
        connector(liftX1 + 10, y(p2), testX0 - 10, testTopY),
        `<text x="${xControl}" y="${controlTopY - 10}" text-anchor="middle" font-size="12" fill="${controlColor}" font-weight="700">${(p1 * 100).toFixed(2)}%</text>`,
        `<text x="${xTest}" y="${testTopY - 10}" text-anchor="middle" font-size="12" fill="${testColor}" font-weight="700">${(p2 * 100).toFixed(2)}%</text>`,
        `<text x="${xLift}" y="${liftTopY + liftH / 2 + 4}" text-anchor="middle" font-size="12" fill="#063b36" font-weight="800">${escapeText(liftLabel)}</text>`,
        `<text x="${xControl}" y="${baseY + 28}" text-anchor="middle" font-size="14" fill="#334155" font-weight="700">Control</text>`,
        `<text x="${xLift}" y="${baseY + 28}" text-anchor="middle" font-size="14" fill="#334155" font-weight="700">Lift</text>`,
        `<text x="${xTest}" y="${baseY + 28}" text-anchor="middle" font-size="14" fill="#334155" font-weight="700">Test</text>`,
        `<text x="${xLift}" y="${liftTopY + liftH + 22}" text-anchor="middle" font-size="12" fill="#0d1b2a" font-weight="800">${escapeText(confText)}</text>`,
        `<text x="${xControl}" y="${baseY + 42}" text-anchor="middle" font-size="11" fill="#5b6777">${escapeText(`${c1}/${n1}`)}</text>`,
        `<text x="${xTest}" y="${baseY + 42}" text-anchor="middle" font-size="11" fill="#5b6777">${escapeText(`${c2}/${n2}`)}</text>`,
      ].join('');
    }

    function mixHex(a, b, t) {
      const aN = a.startsWith('#') ? a.slice(1) : a;
      const bN = b.startsWith('#') ? b.slice(1) : b;
      const ar = parseInt(aN.slice(0, 2), 16);
      const ag = parseInt(aN.slice(2, 4), 16);
      const ab = parseInt(aN.slice(4, 6), 16);
      const br = parseInt(bN.slice(0, 2), 16);
      const bg = parseInt(bN.slice(2, 4), 16);
      const bb = parseInt(bN.slice(4, 6), 16);
      const rr = Math.round(ar + (br - ar) * t);
      const rg = Math.round(ag + (bg - ag) * t);
      const rb = Math.round(ab + (bb - ab) * t);
      return `rgb(${rr} ${rg} ${rb})`;
    }

    function bandAreaPath(xFrom, xTo) {
      const steps = 70;
      const scaleX = 520 / 8;
      const offsetX = 40;
      const scaleY = 180;
      const offsetY = 210;
      let d = `M ${offsetX + (xFrom + 4) * scaleX} ${offsetY}`;
      for (let i = 0; i <= steps; i++) {
        const x = xFrom + (xTo - xFrom) * (i / steps);
        const y = normalPdf(x);
        const plotX = offsetX + (x + 4) * scaleX;
        const plotY = offsetY - y * scaleY * 2.5;
        d += ` L ${plotX} ${plotY}`;
      }
      d += ` L ${offsetX + (xTo + 4) * scaleX} ${offsetY} Z`;
      return d;
    }

    function setCriticalRegion() {
      sig95Area.setAttribute('d', bandAreaPath(-Z_CRIT_95, Z_CRIT_95));
      hitSig95.setAttribute('d', bandAreaPath(-Z_CRIT_95, Z_CRIT_95));

      const scaleX = 520 / 8;
      const offsetX = 40;
      const leftX = offsetX + (-Z_CRIT_95 + 4) * scaleX;
      const rightX = offsetX + (Z_CRIT_95 + 4) * scaleX;
      critLeft.setAttribute('x1', leftX);
      critLeft.setAttribute('x2', leftX);
      critRight.setAttribute('x1', rightX);
      critRight.setAttribute('x2', rightX);
      hitCritLeft.setAttribute('x1', leftX);
      hitCritLeft.setAttribute('x2', leftX);
      hitCritRight.setAttribute('x1', rightX);
      hitCritRight.setAttribute('x2', rightX);
      negLabel.setAttribute('x', Math.max(70, leftX - 48));
      posLabel.setAttribute('x', Math.min(530, rightX + 48));
    }

    function buildNoiseBands(z) {
      const zAbs = Math.max(0, Math.min(4, Math.abs(z)));
      const base = '#d8f0fb';
      const target = '#118ab2';
      const bandDefs = [
        { from: 0, to: 1, center: 0.5 },
        { from: 1, to: 2, center: 1.5 },
        { from: 2, to: 3, center: 2.5 },
        { from: 3, to: 4, center: 3.5 },
      ];

      const pieces = [];
      const capT = 0.10 + 0.80 * (zAbs / 4);
      for (const band of bandDefs) {
        const baseT = 0.10 + 0.80 * (band.center / 4);
        const t = Math.min(baseT, capT);
        const fill = mixHex(base, target, t);
        pieces.push(`<path d="${bandAreaPath(band.from, band.to)}" fill="${fill}" fill-opacity="0.18"></path>`);
        pieces.push(`<path d="${bandAreaPath(-band.to, -band.from)}" fill="${fill}" fill-opacity="0.18"></path>`);
      }
      noiseBands.innerHTML = pieces.join('');
    }

    function buildCurve() {
      const points = [];
      const scaleX = 520 / 8;
      const offsetX = 40;
      const scaleY = 180;
      const offsetY = 210;

      for (let i = 0; i <= 160; i++) {
        const x = -4 + (8 * i / 160);
        const y = normalPdf(x);
        const plotX = offsetX + (x + 4) * scaleX;
        const plotY = offsetY - y * scaleY * 2.5;
        points.push([plotX, plotY]);
      }

      let d = `M ${points[0][0]} ${points[0][1]}`;
      for (let i = 1; i < points.length; i++) {
        d += ` L ${points[i][0]} ${points[i][1]}`;
      }
      curvePath.setAttribute('d', d);
      setCriticalRegion();
    }

    function buildShade(z) {
      const clampZ = Math.max(-4, Math.min(4, z));
      const scaleX = 520 / 8;
      const offsetX = 40;
      const scaleY = 180;
      const offsetY = 210;

      const leftBound = -4;
      const rightBound = 4;
      const leftCut = -Z_CRIT_95;
      const rightCut = Z_CRIT_95;

      function shadePath(fromX, toX) {
        const steps = 80;
        const pts = [];
        for (let i = 0; i <= steps; i++) {
          const x = fromX + (toX - fromX) * (i / steps);
          const y = normalPdf(x);
          const plotX = offsetX + (x + 4) * scaleX;
          const plotY = offsetY - y * scaleY * 2.5;
          pts.push([plotX, plotY]);
        }
        let d = `M ${offsetX + (fromX + 4) * scaleX} ${offsetY}`;
        for (const [px, py] of pts) {
          d += ` L ${px} ${py}`;
        }
        d += ` L ${offsetX + (toX + 4) * scaleX} ${offsetY} Z`;
        return d;
      }

      shadeLeft.setAttribute('d', shadePath(leftBound, leftCut));
      shadeRight.setAttribute('d', shadePath(rightCut, rightBound));
      hitPLeft.setAttribute('d', shadePath(leftBound, leftCut));
      hitPRight.setAttribute('d', shadePath(rightCut, rightBound));

      const zx = offsetX + (clampZ + 4) * scaleX;
      zLine.setAttribute('x1', zx);
      zLine.setAttribute('x2', zx);
      zDot.setAttribute('cx', zx);
      zDotText.setAttribute('x', zx);
      zDotLabel.setAttribute('x', zx);
      zDotText.textContent = clampZ.toFixed(2);
      hitZLine.setAttribute('x1', zx);
      hitZLine.setAttribute('x2', zx);
    }

    function showTooltip(text, clientX, clientY) {
      tooltip.textContent = text;
      tooltip.classList.add('on');
      const pad = 12;
      const rect = tooltip.getBoundingClientRect();
      let x = clientX + 14;
      let y = clientY + 14;
      if (x + rect.width + pad > window.innerWidth) x = clientX - rect.width - 14;
      if (y + rect.height + pad > window.innerHeight) y = clientY - rect.height - 14;
      tooltip.style.left = `${Math.max(pad, x)}px`;
      tooltip.style.top = `${Math.max(pad, y)}px`;
    }

    function hideTooltip() {
      tooltip.classList.remove('on');
    }

    let tipEl = null;
    document.addEventListener('pointerover', (e) => {
      const el = e.target && e.target.closest ? e.target.closest('[data-tip]') : null;
      if (!el) return;
      tipEl = el;
      showTooltip(el.getAttribute('data-tip') || '', e.clientX, e.clientY);
    });
    document.addEventListener('pointermove', (e) => {
      if (!tipEl || !tooltip.classList.contains('on')) return;
      showTooltip(tipEl.getAttribute('data-tip') || '', e.clientX, e.clientY);
    });
    document.addEventListener('pointerout', (e) => {
      const leaving = e.target && e.target.closest ? e.target.closest('[data-tip]') : null;
      if (!leaving) return;
      if (tipEl === leaving) {
        tipEl = null;
        hideTooltip();
      }
    });

    function interpretSummary({ delta, lift, confidence, pValue, bayesInfo, mode }) {
      if (!isFinite(pValue)) return 'Enter valid group sizes and conversions to see interpretation.';
      const pp = formatPP(delta);
      const conf = formatPercent(confidence);
      const confidenceLevel = confidence;
      const significant = confidenceLevel >= 0.95;
      const directional = !significant && confidenceLevel >= 0.80;
      const absDeltaPP = Math.abs(delta) * 100;
      let magnitude = '';
      if (absDeltaPP >= 1 && absDeltaPP < 2) magnitude = 'encouraging';
      if (absDeltaPP >= 2 && absDeltaPP <= 4) magnitude = 'strong';
      if (absDeltaPP > 4) magnitude = 'very strong';
      const tone = delta >= 0
        ? (significant ? (magnitude || 'positive') : 'positive but inconclusive')
        : (significant ? 'concerning' : 'concerning but inconclusive');
      const nextStep = significant
        ? (delta >= 0
          ? 'Evaluate cost effectiveness vs control group. Scale the campaign gradually and monitor downstream KPIs (CPA, LTV) to confirm durability.'
          : 'Do not scale. Reevaluate the campaign creative, offer, and targeting before retesting.')
        : (delta >= 0
          ? 'Gather more data before scaling.'
          : 'Reevaluate creative, offer, and targeting before retesting.');
      const bayesLine = bayesInfo
        ? `<li><strong>Chance of improvement:</strong> There is a <strong>${bayesInfo.probPct}</strong> probability that the Test version is actually superior to the Control in the long run.</li>
        <li><strong>Credible Interval:</strong> There is <strong>95%</strong> probability the Test group’s true conversion rate is between <strong>${bayesInfo.rateLo}</strong> and <strong>${bayesInfo.rateHi}</strong>.</li>`
        : '';
      const freqLine = `<li><strong>Significance:</strong> <strong>${conf}</strong> (p = ${pValue.toFixed(4)}). ${significant ? `This clears the 95% threshold, meaning results this large would be rare (about ${(pValue * 100).toFixed(2)} out of 100 times) if there were no real difference.` : (directional ? 'This is indicative but still inconclusive (often used for tactical decisions).' : 'This does not clear the 80% benchmark.')}</li>`;
      const winnerLine = delta === 0
        ? 'The Test Group did not outperform the Control Group.'
        : (delta > 0 ? 'The Test Group outperformed the Control Group.' : 'The Control Group outperformed the Test Group.');
      const absRel = isFinite(lift) ? Math.abs(lift) : NaN;
      const relText = isFinite(absRel) ? formatPercent(absRel) : '—';
      const liftLine = delta === 0
        ? `You saw no difference in conversion (<strong>${pp}</strong> absolute).`
        : `You saw a <strong>${relText}</strong> relative ${delta >= 0 ? 'increase' : 'decrease'} in conversion (<strong>${formatPPValue(Math.abs(delta))}</strong> percentage points absolute).`;
      let verdictText = '';
      if (significant) {
        verdictText = delta > 0
          ? 'This result supports moving forward with the Test version.'
          : 'This result supports sticking with the Control version.';
      } else if (directional) {
        verdictText = delta > 0
          ? 'This result is indicative and directionally positive, but not strong enough to recommend switching yet.'
          : 'This result is indicative and directionally negative, but not strong enough to recommend switching yet.';
      } else {
        verdictText = delta > 0
          ? 'This result is not strong enough to recommend the Test version yet.'
          : 'This result does not support moving away from the Control version.';
      }

      return `<ul>
        <li><strong>The Winner:</strong> ${winnerLine}</li>
        <li><strong>The Lift:</strong> ${liftLine}</li>
        <li><strong>The Verdict:</strong> ${verdictText}</li>
        ${freqLine}
        ${bayesLine}
        <li><strong>Recommendation:</strong> ${nextStep}</li>
      </ul>`;
    }

    function validateInputs() {
      const n1 = Number(controlSize.value);
      const n2 = Number(testSize.value);
      const c1 = Number(controlConv.value);
      const c2 = Number(testConv.value);

      if (n1 <= 0 || n2 <= 0) return 'Group sizes must be greater than zero.';
      if (c1 < 0 || c2 < 0) return 'Conversions cannot be negative.';
      if (c1 > n1 || c2 > n2) return 'Conversions cannot exceed group size.';
      return '';
    }

    function validatePriors() {
      return '';
    }

    function calculate() {
      const error = validateInputs();
      validation.textContent = error;
      if (error) return;

      const n1 = Number(controlSize.value);
      const n2 = Number(testSize.value);
      const c1 = Number(controlConv.value);
      const c2 = Number(testConv.value);

      const p1 = c1 / n1;
      const p2 = c2 / n2;
      const delta = p2 - p1;
      const liftDenom = p1 === 0 ? 1 : p1;
      const lift = delta / liftDenom;
      const pooled = (c1 + c2) / (n1 + n2);
      const se = Math.sqrt(pooled * (1 - pooled) * (1 / n1 + 1 / n2));
      const z = se === 0 ? 0 : delta / se;
      const pValue = 2 * (1 - normalCdf(Math.abs(z)));
      const confidence = 1 - pValue;
      const mode = 'both';

      liftEl.textContent = formatPPValue(delta);
      seEl.textContent = formatPPValue(se);
      zEl.textContent = `${(isFinite(z) ? z : 0).toFixed(2)}x`;
      pEl.textContent = formatPercentValue(pValue);
      confidenceLabel.textContent = 'Significance';
      confidenceUnit.textContent = '1 - p-value';
      confidenceEl.textContent = formatPercentValue(confidence);
      tileConfidence.setAttribute(
        'data-tip',
        `Significance (1 - p): ${formatPercent(confidence)} (p = ${pValue.toFixed(4)}). This clears the 95% threshold, meaning results this large would be rare (about ${(pValue * 100).toFixed(2)} out of 100 times) if there were no real difference.`
      );
      const sigColor = confidence >= 0.8 ? '#16a34a' : '#ef4444';
      confBadgeText.textContent = `${formatPercentValue(confidence)} significance`;
      confBadgeText.setAttribute('fill', sigColor);
      confBadgeRect.setAttribute('stroke', sigColor);

      const isSignificant = confidence >= 0.95;
      const isDirectional = !isSignificant && confidence >= 0.80;
      verdictEl.textContent = isSignificant
        ? 'Significant'
        : (isDirectional ? 'Indicative' : 'Not significant');
      verdictCard.classList.toggle('verdict-good', isSignificant);
      verdictCard.classList.toggle('verdict-bad', !isSignificant);
      verdictUnit.textContent = isSignificant
        ? 'At or above 95% (p < 0.05)'
        : (isDirectional ? 'Between 80–95% (indicative, inconclusive)' : 'Below 80% (p ≥ 0.20)');

      let bayesInfo = null;
      let bayesProb = NaN;
      let bayesRateLo = NaN;
      let bayesRateHi = NaN;
      let barConfValue = confidence;
      let barConfLabel = 'significance';
      // Legend text is static in markup (and includes tooltip).

      const p1Text = `${c1}/${n1} = ${formatRate(p1)}`;
      const p2Text = `${c2}/${n2} = ${formatRate(p2)}`;
      const liftNote = p1 === 0 ? ' Control rate is 0, so lift uses denominator 1 to avoid division by zero.' : '';
      tileLift.setAttribute('data-tip', `Absolute lift (pp) = p2 - p1. Control rate p1 = ${p1Text}, test rate p2 = ${p2Text}. Lift = ${formatPP(delta)} (relative lift: ${formatPercent(lift)}).${liftNote}`);
      tileSe.setAttribute('data-tip', `Pooled rate = (${c1} + ${c2}) / (${n1} + ${n2}) = ${formatRate(pooled)}. SE (noise) = sqrt(p_pool(1 - p_pool) * (1/${n1} + 1/${n2})) = ${formatPP(se)}.`);
      tileZ.setAttribute('data-tip', `Z = (p2 - p1) / SE. Delta = p2 - p1 = ${formatPP(delta)}. Z = ${formatPP(delta)} / ${formatPP(se)} = ${formatNumber(z)}.`);
      tileP.setAttribute('data-tip', `Two-tailed: p = 2 * (1 - Φ(|z|)). With |z| = ${formatNumber(Math.abs(z))}, p = ${formatNumber(pValue)}.`);
      tileConfidence.setAttribute('data-tip', `Significance (1 - p): ${formatPercent(confidence)} (p = ${pValue.toFixed(4)}). This clears the 95% threshold, meaning results this large would be rare (about ${(pValue * 100).toFixed(2)} out of 100 times) if there were no real difference.`);
      verdictCard.setAttribute('data-tip', isSignificant
        ? 'Significant: the p-value is below 0.05 (95% threshold).'
        : (isDirectional ? 'Indicative: significance is between 80–95% (often used for tactical decisions) but still inconclusive.' : 'Not significant: significance is below 80% (p ≥ 0.20).'));
      commentary.classList.remove('pulse');
      void commentary.offsetWidth;
      commentary.classList.add('pulse');

      if (true) {
        const priorErr = validatePriors();
        if (priorErr) {
          validation.textContent = priorErr;
          return;
        }
        const pooledRate = (c1 + c2) / (n1 + n2);
        const EB_PRIOR_STRENGTH = 20;
        const priorN = EB_PRIOR_STRENGTH;
        const priorRate = pooledRate;
        const a = priorRate * priorN + 1;
        const b = (1 - priorRate) * priorN + 1;
        const a1 = a;
        const b1 = b;
        const a2 = a;
        const b2 = b;
        const postA1 = a1 + c1;
        const postB1 = b1 + (n1 - c1);
        const postA2 = a2 + c2;
        const postB2 = b2 + (n2 - c2);
        drawBayesPosterior(postA1, postB1, postA2, postB2, p1, p2);

        const samples = 1000000;
        const diffs = [];
        let wins = 0;
        for (let i = 0; i < samples; i++) {
          const s1 = betaSample(postA1, postB1);
          const s2 = betaSample(postA2, postB2);
          const diff = s2 - s1;
          if (s2 > s1) wins++;
          diffs.push(diff);
        }
        diffs.sort((a, b) => a - b);
        const lo = diffs[Math.floor(samples * 0.025)];
        const hi = diffs[Math.floor(samples * 0.975)];
        const prob = wins / samples;
        const rateSamples = [];
        for (let i = 0; i < samples; i++) {
          rateSamples.push(betaSample(postA2, postB2));
        }
        rateSamples.sort((a, b) => a - b);
        const rateLo = rateSamples[Math.floor(samples * 0.025)];
        const rateHi = rateSamples[Math.floor(samples * 0.975)];
        bayesProb = prob;
        bayesRateLo = rateLo;
        bayesRateHi = rateHi;
        bayesInfo = {
          probPct: `${(prob * 100).toFixed(1)}%`,
          rateLo: `${formatPercentValue(rateLo)}`,
          rateHi: `${formatPercentValue(rateHi)}`
        };
        tileZ.setAttribute('data-tip', `Bayesian: P(test > control) = ${(prob * 100).toFixed(1)}%. 95% credible Test rate: ${formatPercentValue(rateLo)} to ${formatPercentValue(rateHi)}.`);
        barConfValue = prob;
        barConfLabel = 'chance of improvement';
        if (bayesCallout) {
          const calloutText = `${(prob * 100).toFixed(2)}% chance of improvement`;
          const w = 240;
          const h = 32;
          const x = 600 - 26 - w;
          const y = 34;
          bayesCallout.innerHTML = `
            <rect x="${x}" y="${y - 24}" width="${w}" height="${h}" rx="14" fill="rgba(255,255,255,0.92)" stroke="#16a34a" stroke-width="2"/>
            <text x="${x + w / 2}" y="${y - 3}" text-anchor="middle" font-size="12" font-weight="800" fill="#166534">${escapeText(calloutText)}</text>
          `;
        }
      }
      // Bayesian chance of improvement is shown in the bar chart + summary.

      commentary.innerHTML = interpretSummary({ delta, lift, confidence, pValue, bayesInfo, mode });

      buildNoiseBands(z);
      buildShade(z);
      zLine.setAttribute('stroke-dasharray', Math.abs(z) <= Z_CRIT_95 ? '7 7' : '');
      drawBars({
        n1,
        c1,
        p1,
        n2,
        c2,
        p2,
        delta,
        lift,
        se,
        confValue: barConfValue,
        confLabel: barConfLabel
      });
    }

    document.getElementById('calcBtn').addEventListener('click', calculate);
    [controlSize, controlConv, testSize, testConv].forEach(el => {
      el.addEventListener('input', () => {
        validation.textContent = '';
      });
    });

    buildCurve();
    setModeUI();
    calculate();
  </script>
</body>
</html>
